# v2
# file: simulation/README.md

# BookKeeper Workflow Simulation – Architecture & Usage

## What does this code do?
This directory implements an event-driven simulation of the Apache BookKeeper development workflow,
including all feedback cycles as observed in the real ASF/Jira process.

- **Entities:** Tickets, queues, servers (dev/review, testing)
- **Events:** Ticket arrivals, service completions, feedback loops, ticket closure
- **Service times:** Drawn from empirically fitted heavy-tailed distributions
- **Routing:** Feedback probability after each phase (parameterized)
- **Stats:** Per-ticket and aggregate output, fully logged

## File Structure

- `simulate.py` – Main runner (schedules, runs simulation loop, coordinates everything)
- `events.py` – Event and EventQueue classes (arrival, service, feedback)
- `entities.py` – Ticket entity and overall SystemState (queues, servers, feedback logic)
- `service_distributions.py` – Utilities for sampling fitted service times
- `config.py` – All simulation parameters (arrival rate, feedback p, distribution params, etc.)
- `stats.py` – Collects stats, outputs CSVs and summary stats
- `logs/` – Simulation logs (stdout + file)
- `output/` – Simulation outputs (per-ticket CSV, more to be added)

## Configuration workflow

`simulation/config.py` is generated by `simulation/generate_sim_config.py`. The generator ingests the ETL arrival/service metrics (`etl/output/csv/tickets_prs_merged.csv` and `fit_summary.csv`), computes ARRIVAL_RATE/feedback/capacity, and wires in the Markov-state artifacts under `data/state_parameters/`. Regenerate the config whenever upstream ETL fits change:

```bash
python simulation/generate_sim_config.py
```

The script is deterministic (no timestamps in logic) and will fail fast if the ETL inputs or Markov/state files are missing.

## Markov inputs and reproducibility

- `data/state_parameters/matrix_P.csv` and `stint_PMF_*.csv` (plus `service_params.json`) are recorded in `STATE_PARAMETER_PATHS` inside `config.py`. Simulation startup verifies the files exist before scheduling any events.
- Randomness is centralized via `GLOBAL_RANDOM_SEED` (and stream-specific seeds) defined in `config.py`. To override for a run, set `SIMULATION_RANDOM_SEED=<int>` in the environment before invoking `simulate.py`.

## How to run

1. Install dependencies (see below).
2. Regenerate `config.py` if ETL fits changed (see above).
3. Run the simulation:

    ```bash
    python simulation/simulate.py
    ```

4. Outputs:
   - Log: `logs/simulation.log` (also echoes to stdout)
   - Stats: `output/ticket_stats.csv`

## Requirements

- Python 3.x
- numpy

## Notes

- Service time distribution parameters are **examples**; update with your fitted values!
- Feedback probabilities (`FEEDBACK_P_DEV`, `FEEDBACK_P_TEST`) must be empirically set.
- Simulation is fully modular for further extensions (parallel servers, multiple queues, etc).

---

*See code comments for more on logic and usage.*
